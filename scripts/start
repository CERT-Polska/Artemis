#!/bin/bash

cd $(dirname $0)/..

exists() {
    [ -e "$1" ]
}
if [[ $(uname -m) != "arm"* ]]; then
    PROFILE='--profile not-arm'
else
    echo "Some modules are not supported on CPUs with ARM architecture - not starting them. "
    echo "To make use of all Artemis features, we recommend using an x86 system."
    PROFILE=
fi

if exists Artemis-modules-extra; then
    ADDITIONAL_OPTIONS=--scale=karton-sqlmap=5
else
    echo "We recommend you to add additional Artemis modules from https://github.com/CERT-Polska/Artemis-modules-extra/ "
    echo "- these modules havenâ€™t been included in core due to their licenses (e.g. GPL or AGPL), but provide additional "
    echo "features such as e.g. SSL verification (certificate validity, proper redirect, etc.), subdomain takeover check or SQL "
    echo "injection check."
    echo
    echo "CERT PL finds tens of thousands of misconfigured SSL and hundreds of SQL injections using these modules."
    echo
    echo "To set up Artemis-modules-extra, clone https://github.com/CERT-Polska/Artemis-modules-extra/ inside "
    echo "the Artemis directory and run ./scripts/start."
    echo
    ADDITIONAL_OPTIONS=
fi

# We don't use `-d` here so that the user sees the logs by default.
./scripts/run_docker_compose stop
./scripts/run_docker_compose $PROFILE up --build \
    --scale=karton-wp_scanner=3 \
    --scale=karton-identifier=3 \
    --scale=karton-port_scanner=5 \
    --scale=karton-wordpress_plugins=5 \
    --scale=karton-nuclei=5 \
    --scale=karton-bruter=5 \
    $ADDITIONAL_OPTIONS
