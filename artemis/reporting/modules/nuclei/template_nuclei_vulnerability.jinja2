{% if "nuclei_vulnerability" in data.contains_type %}
    {# If we group by template_name, all reports in the group will have the same vulnerability data: #}
    {# description_translated and reference #}
    {% set any_link_printed = 0 %}

    {% for template_name, reports in data.reports|groupby("additional_data.template_name", default="") %}
        {% if template_name and reports.0.report_type == "nuclei_vulnerability" %}
            <li>
                {# We can't just use 'set any_link_printed = 0' - see https://jinja.palletsprojects.com/en/3.1.x/templates/#assignments, section Scoping Behavior #}
                {% set any_link_printed = namespace(data=0) %}
                {{ reports.0.additional_data.description_translated }}
                {% trans %}The vulnerability was identified on:{% endtrans %}
                <ul>
                    {% for report in reports %}
                        <li>
                            {# Here we don't dump the full PoC/url but: #}
                            {# - if the URL is without query and fragment (e.g. https://example.com/server-status) we show the full URL, but #}
                            {#   splitting between domain and path (printing e.g. "on https://example.com under /server-status") so that e.g. #}
                            {#   bots or people routing the e-mail to the security team don't click the link, #}
                            {# - if the URL contains query or fragment (e.g. https://example.com/?file=../.././../etc/passwd) we show the full URL #}
                            {#   in the form of "on https://example.com under ?file=../../../../etc/passwd" only #}
                            {#   if it's a subsequent reminder as sending PoCs may trigger spam filters, #}
                            {# - in other cases, besides vulnerability description we only show the hostname, protocol, and port #}

                            {% if report.additional_data.is_url_without_query_fragment or report.is_subsequent_reminder %}
                                {{ report.target }}
                                {% if report.additional_data.path_query_fragment %}
                                    {% trans %} under {% endtrans %}
                                    {% set any_link_printed.data = 1 %}
                                    {{ report.additional_data.path_query_fragment }}
                                {% endif %}
                            {% else %}
                                {{ report.target }}
                            {% endif %}
                            {{ report_meta(report) }}
                        </li>
                    {% endfor %}
                </ul>
                {% if reports.0.additional_data.reference %}
                    {% trans %}More information is available on:{% endtrans %}
                    <ul>
                        {% for reference in reports.0.additional_data.reference %}
                            <li><a href="{{ reference }}">{{ reference }}</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% trans trimmed %}
                    Please contact us if more information is needed - e.g. an address
                    or command that proves that the vulnerability exists.
                {% endtrans %}
                {% if any_link_printed.data %}
                    <p>
                        {% trans trimmed %}
                            The above links are automatically generated - contact us if they aren't sufficient for
                            you to reproduce the vulnerability.
                        {% endtrans %}
                    </p>
                {% endif %}
             </li>
         {% endif %}
     {% endfor %}
{% endif %}
